<script>
  const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbyq5qrUaTAcLNlF5Ps_biZcQWa8SXZU1FfL4EX_rTZwXdz8a-pMC_P_CDAzvUq3yODk/exec';
  document.getElementById('fecha').value = new Date().toISOString().slice(0,10);

  document.getElementById('guardar').addEventListener('click', async () => {
    const msg = document.getElementById('msg') || (() => {
      const el = document.createElement('div'); el.id='msg'; el.className='msg'; 
      document.querySelector('.card')?.appendChild(el); return el;
    })();
    msg.textContent = ''; msg.className = 'msg';

    const producto = document.getElementById('producto').value.trim();
    const tipo = document.getElementById('tipo').value;
    const fecha = document.getElementById('fecha').value;
    const comentario = document.getElementById('comentario').value.trim();

    if (!producto) { msg.textContent = 'Ingresá un producto.'; msg.className += ' err'; return; }
    if (!fecha) { msg.textContent = 'Seleccioná una fecha.'; msg.className += ' err'; return; }

    try {
      // Proxy CORS para evitar bloqueos entre github.io y Apps Script
      const res = await fetch('https://cors.isomorphic-git.org/' + APPS_SCRIPT_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ producto, tipo, fecha, comentario, origen:'manual' })
      });
      const data = await res.json();
      if (data.ok) {
        msg.textContent = 'Movimiento guardado.';
        msg.className += ' ok';
        document.getElementById('comentario').value = '';
      } else {
        msg.textContent = 'Error: ' + (data.error || 'No se pudo guardar');
        msg.className += ' err';
      }
    } catch (e) {
      msg.textContent = 'Error de red: ' + e.message;
      msg.className += ' err';
    }
  });
</script>